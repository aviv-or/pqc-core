const should = require('chai').should();
const expect = require('chai').expect;
const _ = require('lodash');

import pqccore from '../../../lib'

const {
  Script, Address, Transaction, PrivateKey
} = pqccore
const {BN, Signature} = pqccore.crypto
const {Input, Output} = Transaction
const MultiSigInput = Transaction.Input.MultiSig;

describe('MultiSigInput', () => {
  const privateKey1 = new PrivateKey('2ShLGGW7NPNdTJsYKkVxx8Wp5ThyASmpumDKkj5P8iCGia7s3yXY3AnhCQRs9kQeYEoHjGHgmDCLhynE2RZPfQYh8ej1YGK');
  const privateKey2 = new PrivateKey('2SV7QR25RCZAT6GeyhmTAw6Rrm4JSywAUKow9CWnY277c8BeHv7B2UNJPm3sG6zm8cSn2qNozy2yco6nVFMuy1q7ojNdsUB');
  const privateKey3 = new PrivateKey('2SWYiDzgzw1dmDh1SfZXi51kBUD6A1Qzncjf4Fgi1zm4LqxaM9qtRnLULeZjwMc97sfxwAka9j8Kz2d8VSwgFAKuj8AUgmg');
  const public1 = privateKey1.publicKey;
  const public2 = privateKey2.publicKey;
  const public3 = privateKey3.publicKey;
  const address = new Address('Lfci7ooSc31oNijNG9zDeHBBHJddxrPEKX');

  const output = {
    txId: '66e64ef8a3b384164b78453fa8c8194de9a473ba14f89485a0e433699daec140',
    outputIndex: 0,
    script: new Script('524c8204401a09ab4ef7473b4f7f59f2c9bc8413b514cd0d5bc1c5b3f4256282d1edfd3027421e16944bd6e863a4dfe843c0c8f0524a1e6a4afd03ef2d7b62582c9c1bd1a71a09ab4ef7473b4f7f59f2c9bc8413b514cd0d5bc1c5b3f4256282d1edfd3027421e16944bd6e863a4dfe843c0c8f0524a1e6a4afd03ef2d7b62582c9c1bd1a74c8204402c95ddf8dc83d7ec53c6181c2d44904fb6e77e788a5564553454e73dab81d15c056ba6ef65a3dfbaf3083c40f774d15ae2d79a6cc06099956d44a7f3c85646a52c95ddf8dc83d7ec53c6181c2d44904fb6e77e788a5564553454e73dab81d15c056ba6ef65a3dfbaf3083c40f774d15ae2d79a6cc06099956d44a7f3c85646a54c8204407b51912d071d2f13494fb6413683522ea3b141a58cc316de21fa411109bd62bedfeab09fab9f14e6501239c16d7faa025502672912159cc0e7874f46a398e8977b51912d071d2f13494fb6413683522ea3b141a58cc316de21fa411109bd62bedfeab09fab9f14e6501239c16d7faa025502672912159cc0e7874f46a398e89753ae'),
    glv: 1000000
  };
  const sc = Script.buildMultisigOut([public1, public2, public3], 2)
  console.log(sc.toHex())
  const add = Address.createMultisig([public1, public2, public3], 2, 'testnet')
  console.log(36, add.toString())

  it('can count missing signatures', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];

    input.countSignatures().should.equal(0);

    transaction.sign(privateKey1);
    input.countSignatures().should.equal(1);
    input.countMissingSignatures().should.equal(1);
    input.isFullySigned().should.equal(false);

    transaction.sign(privateKey2);
    console.log(41, transaction.toString())
    input.countSignatures().should.equal(2);
    input.countMissingSignatures().should.equal(0);
    input.isFullySigned().should.equal(true);
  });
  it('can count missing signatures, signed with key 3 and 1', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];

    input.countSignatures().should.equal(0);

    transaction.sign(privateKey3);
    input.countSignatures().should.equal(1);
    input.countMissingSignatures().should.equal(1);
    input.isFullySigned().should.equal(false);

    transaction.sign(privateKey1);
    console.log(69, transaction.toString())
    input.countSignatures().should.equal(2);
    input.countMissingSignatures().should.equal(0);
    input.isFullySigned().should.equal(true);
  });
  it('returns a list of public keys with missing signatures', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];

    _.every(input.publicKeysWithoutSignature(), (publicKeyMissing) => {
      const serialized = publicKeyMissing.toString();
      return serialized === public1.toString() ||
              serialized === public2.toString() ||
              serialized === public3.toString();
    }).should.equal(true);
    transaction.sign(privateKey1);
    _.every(input.publicKeysWithoutSignature(), (publicKeyMissing) => {
      const serialized = publicKeyMissing.toString();
      return serialized === public2.toString() ||
              serialized === public3.toString();
    }).should.equal(true);
  });
  it('can clear all signatures', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000)
      .sign(privateKey1)
      .sign(privateKey2);

    const input = transaction.inputs[0];
    input.isFullySigned().should.equal(true);
    input.clearSignatures();
    input.isFullySigned().should.equal(false);
  });
  it('can estimate how heavy is the output going to be', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];
    input._estimateSize().should.equal(147);
  });
  it('uses SIGHASH_ALL by default', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];
    const sigs = input.getSignatures(transaction, privateKey1, 0);
    sigs[0].sigtype.should.equal(Signature.SIGHASH_ALL);
  });
  it('roundtrips to/from object', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000)
      .sign(privateKey1);
    const input = transaction.inputs[0];
    const roundtrip = new MultiSigInput(input.toObject());
    roundtrip.toObject().should.deep.equal(input.toObject());
  });
  it('roundtrips to/from object when not signed', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];
    const roundtrip = new MultiSigInput(input.toObject());
    roundtrip.toObject().should.deep.equal(input.toObject());
  });
  it('can parse list of signature buffers, from TX signed with key 1 and 2', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction('010000000140c1ae9d6933e4a08594f814ba73a4e94d19c8a83f45784b1684b3a3f84ee66600000000fd1312004d060930000000001d0aeb172c9ebad6566274c79c533295b85653cb961cc68bcf551b9e0802db25ea995e1d3cfe88f1983f4aaf23659f8e00035ae52a64bdb2a46976e62e38add732279622df91902ab54620ec739abb78b3bf5040df57416a12d236e69464e81db7a77467aec816d7455e55e9ca432220cfd713187b360665bbf5b2110623a169b3e7886a022196c13ee45c6e3dfe8a694c9e45f3dd291a3fa8efa624f01e6fac335d474e0f602f83643d1ad2041cd68c07248c3157f21d7bdae917f33a6253a432e622fe496b0603c74da63181bc7797abbaba27a04be53670f9445bf055e3d35e56fd2bc9aba7b54c35c6aa4592b275f782d4dea2c8c5527cef8007402253ce350f3a2bd16aa94dbb59d70ecec4d8590209b7bb84ce9650415b0d00190cf4e3adeb471066f9d61c50b0cceb0f72117e259bc7a294a76476622b0aff343181a62a2c09b3ad31510a732487fdb97ba16ef98d4231794b58107b59a268e034e8a1752852aa2474d1abbfb32dcd137cfd88e7849b6b508cfb1185bbce70479916e47ced3f418b3f32d9648704f9f37b6f6db5a347b2a0bdae9a9e2ad6ead17d85ddc5f0d71f7b17104c204abc948f1e99ce46bcd0aba795547a8dc8447d00765990374dc72f29dd4d7a1f8567e386bc1f59fbf5c6568780ceed856219e2933f9f72bb7e4978c49c12ba3ccd41ed1d632f82616fb32d6575d6a73d9b294a2b734406b040e852219c46514d278af750bd0b976c07e6d3a7bb19357189bfd3a4f8936bac0c6c12c31762105dd97f68ccf239a237902ff191c6109f454436fbc422cc1d87444b742f91f81f94c29541a2fb58f1fb485637c6b4d7dd8eb45c8c6815336feb8b0ff5fbea82b3abd22d9283e5becb650f52e621521d1815fca688837bd8ff4dda539629c45a59ebb201c6f25c289ffa9eaa068101aae4a1f9453a24a48205bca9da18061bacd81e56600be38bfcce11cb1a774a0e82495bae4b37dad21beac877bb3e1e1db6419ce04be54e79efdd977115c5afb7f70f44dbeb71bd0a85845b7811b392459187cb1ed87fe2cb6767b6d29afa3ce5aa7998fe69d3d89bfe3ac651b78ccd2b1023fd81df92b13d5f6cff7ec530402f67d086ebef33fd63749ccd8f8d588346ba7339ed211658aebd3ea689ece2191db7989f5b6d7ef54f050b6cf2662458657ff848a59bb853fbb1fbe053f54b611530028549438d19c278dd3d851d4c4760e026f60b292407a0e7e2ff986fc4c23248d0fd3cb32e7df02041ee0f9aa4cb5874d9419dc31e954befa9d77b275e85515b7037c1b815fe93838b4ac1bc5db3c3ab0bb726da3cf1656400d988be4a1fcff0505a82112a6505d48e77176fd2a52e6bb54a35eaae0a8b04f9f5fc457af2c09ba219175b6fa8889e99e23defadaab2cdef46fa0a081f5e543795ebf78b35010ff087169022d4eab1c2e03598498c2c2c8c71848085cfd70d5ae061bd5b691ca580038be5447d459353effe7311eebedf2cf456007ee4ea26058f64d7cdaff21cd3149f63933ab58d68263dfcb8dc2fe31f8127c8076fa30f9ddc0c1c11ccc5d4dca67c51d239d3bc16b5f577437c6bd2a5e64048ae957294669d0d7940b6d45409d91f24c8d8f108e1e2a2aca42bd61f84eb5d63d8487b58a580c7edbc6952c03a986180da9c24026bd6e720977e96a5edcd7f91f4e4ff4befcdafb2ad6b555af33bd9b948e89e4926ec34948e7d0119174b6e1b805923db50956cf158e6a0b0f9625a42d7cab51b3f7154d82d980d5c65234449fa034bc9261bb53eab9f7e615bb2ef7d1e31f710a1687654e3f7812bc369fc1e0bf8810c628b315e31e09e7f2dd51f9bbc7a0894a2bf988f2bd08c9522a28c34f72a72de30e14077e5ba8e9efd1807ab6381e32bd289665e218f3ff0caad5d4558ca4b13ce10f42c2445e767b5345438c5e40e90f12f9020d77d06931414b5c310f57c89e4c9a9d7e61133773ed6a3ea435be72e77a60e68f0d6c9232a64f446e9872a4ff9fc06e310c9d6d603d984a766a9770e8987448e41b74bcd9eb47726b4bd1313b5ce0ad442c434d99b7541e162f6d74876ad7484e2124018aa7b033c7f1fcb297896f37a781018fe2c2fc864eaf76db2a70cdeca1bb5c73606d1b453e4fef4d7fc393a842508c4ebe69ba124ef7bd99b8e67c021120277131c954cd6f9c9201d5fbd3bdfa183f9c68088f27b3f996b30917a707df31971c85d74e6d81815fe35cc68575db513e1bac3db8304165c1e0eacdb61aea57f74ee3dc2d61957206e4d0360cfcfbdf436018e9adff37f37d990488fc751d6ab4001f5f9a7c9eaef5e8f2b47ce353e80225e3832a64fc846891f7240e6309b14c1e80a260df3b63c163b16d3e8a22117c94d92c00286e1b534a011b58712a346d87bfdab9d7704a50e0e59967cc52c0bdebc14b4e84947b9344a24bdf9514d1cc300d114fd23670e156e4a2b7d11d04f691d0f01629517601f3db04c74a4261c0f9f3c5ba03a6e06f7b15b5b2a9e074f418dae6b691d9d717c4815ad194a2d3ed609e1f0ae7f06fc0aee8de844a5772979dc607090c786afeb64525f3c71df7d9232a23abf33542a82237342c683f18fc8e07d04858d6c26acda39f2ef1fb25a69eff74c6ad62fc4d780192bf71e140cc29fdb7f53afd41916e786cfbc305e5366836e166a8a376ee21b7d9905542942a5f0bc1e6431bb1761a67072d9aaa7e8a900b02aa227a14a22318d0ba5b4569a2d86ae10d1206f19ea49e1b2764826ddd3c7e4cb29a9e139f1ad621ff22a1dc59100cc50f755062349587986793a3a66bdd426101ab4f0d233e7e798d75c071e2f5bf2ac4a2024fbad80fba9c125cd92a8eab36bd1cec6af2ed2e6cc453a03137c7c6749b4d76fe8db8120d5a7010ce72be68c505432bdb6e22bf510f2c51946d917bbc69b32c756392a78feb6ec3b40b188fcf2ac4f49c1e1b007a7f84c70e9e74ac8e6aecf23854420467a459e7be3006adb849d92122b193a872c1ac752fd07f80a09fc2652618dd0adb3d048836241deb2dfcae22530a94fc4d1cfd287e8b7ee2a7c2aaf9233ee870c17bd09ef4463506d0f72c5b393d930c39310954c2699356fc3c9a35c7bb8d575c7a30fb16a8b010e56087a89439e7833005f5fee46935794dac33c192c3582d7aee80e6adfbf2bc90a0e5ec90dede3e19ab1f3ec7c1e9a0ed6ca3770059ffc144dbf0efb70a05d1992b684277b0ebbf93190e30109d562416bed7c0d06198e02014d06093000000000c57c9bc92496dd63efc7e449288dabd59a00e5e1cec499dae21624912ae0e9050b8b225d0c60099d34c06feabe9f8f769c45c2cc8c566265919ed90c3b597a66501a02e92a42cc0bfdf904f68afee96ae1e8494529920bbcb17809bba7e93e5a31a30f388ad924b212becbac1416c29349edb2515925228be9337cdcab98aed1bc2cffae5a6434c4ef75437fcecdcbc63036506ac474e1650dceb08353c1bdc607df5b2d60de469bd9632ae5f575f333ef9dc3716aa005c18a915bda1cbdbab6d93029070625f03e084b29f5aecad555da90c98b2860f1c54b4086dbecc94f1ff1034c4f4b381e709b4990e5aa06fd0eb13a2711ea7a39f90d9e5d43398b167adb468e42a011c3703670b714970da7d9ce84450c7b0c4ee5159ff12ec4e06e68019c10e70acffbe2470ec3284f441142467e0c76f01abedac516d7ef65c42e0a9e43be8f08c8a416f888c8c57248cc6b6032b558824fcbd72df73e5a62c4ee02fbafc3408ed4798595c804f957f813ff03548ac4388e26bfb350fb5a73b381eb53ddc3d3e7dd4fdde0978ccf09e6a5c93826c91760f2cbb19b28083c1cad559bbb542299873da74186b660450468e34c575840d70104031d603285a01c9fbc9f9902f35ee5bd98a85e08d81cfdee0dff97cd389b6bc9e33de5419b9b05f72c6c9c2fdd82c10a1c184a28a385dbed79d8a30ad050b4f76ca43c4c65aa41987dc7f05b3647e8eda85a27a8e2270f4fac79065b47dae7bb228f4c2557b1a13b3d03f1243a2521128d7f5ec6aed843c0b92f0bb00379ba7bc7267321b37804d1e7ddfc11543862477b5da9cd481062d99653e011b932d82536f62dc895efdca034d278569546ca26b63bc9a30df093d729a39b3d89d75fb53917b3a8f52693a00ecda780d4becc86d43989af44de80fdbdaa50a0fb0b53119dcf11949843aedf99b466cfd1e6bd8b6f4bddbb624eefcfa8970f832f7bd966212b71e24190bbfda84e5b32ebad1c53754e8c461966f030829063b6acbf01fca7341b724b0bc22534f358eedeb8facb40c19df7c03024268cbfe135eaf72f3beedf3ed3d9c983caea7e43925fd5f6d63bbd76ebfb8f68787a8d85e0154ac289a79cc99ce54d30deca6b991dfa92ee2ebff577f857af6cdab2f571d5fab13c54971dbc4f9a1eb41571d5aa4616f713512e3cc0650bf6fc94a76052ebf1ce4152b5707344734fc0a5b78f6e4793f31589e8bb67ff4de5804814a723a0ea666dd4cd26c18198e87ec40c49afd18cb5aca962c022094415688ae61985a9e9447bde4781b886074ff8f06fa09942741bad92008f16f5c1d48b10c34917b7530e0098f230d7aa1e3463a5252f2ef87939f3ed0723002104d62d52e65f544c0a544e6f07826837c7e50de757b8e257ea7c0630d35d864da3d926f904c72db736cf29ba2c2120cef2c6422666307452ea777579acc70249f5b777afa650b1e6dbcf45e841dba65df1a108084aef5d0a07520db0542f3062137c1442242148205a216ed3acfb22789981c4e18e758b7c7b75822b087476fb010ff7139fc474b730d739668e5661ffca3cac500d4c887aa2fae552ab9a7044def648bd15aea64be7b5b4102575992b3e5d1e102c4f643551be31bacc09de21f116adf08b220d772534feff16b9507e7d59609fe04289c67d2ea35b94f7975ecaf4e6998dd94de8c37296ffa565b4245632d323d0ea580cbf30e9627d63fbe72340389d61a2d62ac4a3d82b3149830e4d7af70189b49ae05bbcc38bd32a7c1ce98ebd57f9fefa703ecab9b34eac4207caa4a28be05d8c2df44376fa50120d36f833e249fb4efbab097dacf333fe5123a42ac7007abc6c5df8273506d812106bcb92e04afff16d3aaecf626a0ab6922000f4d0007a6dcbf959eadabebe8b393c37209297b6548c315ee36b7977ea90a56ed401ff1b162cdc36ff9b702a33438aef56aa1dbeed6d0465d337834807133886fa322b9efe99c8b5f210814e10622a4d61479620100db8a9e5f9a5fa7d38bf900024f01309db090294c5c9b39cf1140b1eed9c6fbfbfa5dfdcbd735ad4e1d56e80e64f1447e3f2f6771c514989024f0490333e68468295a437f289456f07b71f6d92f94b55750bb95fd991666c36944ebe665630f53f5a7c0068f9932f5d37c78a8013c1e5db22786ee0d8006954f10003024fc5e9b81646288f56a260706f813a57f14f4a32226b398152dcddc1e32a9e8f60698888a36e32a2c88562451f3ed995683d39725f118d0b74fcb59a393d23c363404222942398d88e1ca836f6d6685a4e9ce3c765743040a2c027b14399ac859e9205e880cbd190b981449034b1fd3ef65ad8edec8fda8f9750f911d1a0846b6bd39aabe0b7c9efc76e2d323ac5a2ef0d8d13e8699e6af39074e24057926fe3f3e77c550ef2722e82f3dfcb46cd7b8fdbc60acd26e08938c56e498fd43edd26acfc487061261fb43fb3b390831f204bdbb3efde917af92f3e9e1fad4d8d29bd25c46e89a9fe49cafb7b45aa244e0d0e0a7757c48e1322895e7b3425bb3d6a4cabbe55bca39ff1c6c783b12ca7e6f1de4f543671cc0a97022447fed54ce1168341b5639795ab6a60be3309c0b0ca30b6cba3b04dabfcb505b82fd8dd1c64a9492def2dff7ea2dc309c4d69b796d0d3acf42fd2a1236803f1cc040ae654f2ac3f7e5dfc013e1017ff77ee3d88b63c7b972e09c5aec69817464acfd4bb31cbce1e4e17595e39d1ac436cdd4c476280d10fa82d270416a8abe7e3c00873c666a9e2c7fa56fad4c3891cbad0f1fa659f431a95cc397f32defa8ffa4655e5684b8fecf14e5a8b7145dbf4bb0bdbaa26c365f5eed58a3c3330525d95d31fb4cc92c885163319be0a04124e3edb24b946b16ec75a0fae25d3b8268e74bd8aeda500515bb2ff6120b865e9493ebf5d0992a87567ea23dd3f3b91fe80d1ddda86d04b51d9e4acf4400e5cf16e060a4351b95dcd53e3a060d3768ef269effc124805cc20f34756c9d3f304f68175c94ba9e2be7fbe2b53367117b371fcc645b687cb6ff0a8b80505b27a0581710e0071828f07633decccf4b276cb8544c9852d026cc946224f4d17dfbff63e624feaf92555f4a6f032e7d44da91f3eb9fdd10cda0db708e56dd1197647a558599ca9f257fcfc00cfaf45ebd22ec1ae74d96f344314e3ccf69d803e33a43097ab4804497b6f6b85110d068670009a8fb8878135a7497a039560a83ecb90c4c7ca21006a452774365b94f55801ffffffff0140420f00000000001976a914dfb046745e95abf6d4cb7a1710f6d65bd2b9cbe188ac00000000');

    const inputObj = transaction.inputs[0].toObject();
    inputObj.output = output;
    transaction.inputs[0] = new Transaction.Input(inputObj);

    inputObj.signatures = MultiSigInput.normalizeSignatures(
      transaction,
      transaction.inputs[0],
      0,
      transaction.inputs[0].script.chunks.slice(1).map((s) => { return s.buf; }),
      [public1, public2, public3]
    );

    transaction.inputs[0] = new MultiSigInput(inputObj, [public1, public2, public3], 2);

    transaction.inputs[0].signatures[0].publicKey.should.deep.equal(public1);
    transaction.inputs[0].signatures[1].publicKey.should.deep.equal(public2);
    should.equal(transaction.inputs[0].signatures[2], undefined);
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[0]).should.be.true;
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[1]).should.be.true;
  });
  it('can parse list of signature buffers, from TX signed with key 3 and 1', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction('010000000140c1ae9d6933e4a08594f814ba73a4e94d19c8a83f45784b1684b3a3f84ee66600000000fd1312004d06093000000000f30a5e943fc88ee9fca2cf52319d4072a8ebac77c4e154e8a3a6f53742f13befa9e6b60dacd2679a569b3ebfdba53d37107e9526d7045d53405200b68d654b7886cf6ec7d45c1abba2f79eaa1ea79d271b5eee847745660aeb7b4c4c6a51122a6c4f96254d390881429cba16beb8bb6fe2fef2dc844bd0397e9038640b32f14605bdbbf5096a55e2a7ad9d665b3e705d78ba604c03764b7680042a9b220244a7791b9c85a52d93fc5a113da6dde473742268226663922d4635be949b3dfacaaeb2a2308fd568b91a6d3d2217fe49ea47260418cad6cd48a11a9388e32ca5eb3cd088173a47b1307584e9f71291add7e57840aceea9ef935e44544801767ba66949530aebe5c82544f97fb8269a72dd3cc5d35d6301830754a36adb514ff09d098e4f8421cc92b7f463d1af0245263ba26b885d4fcbcd7021d009b8cf9083a3fdf7d32e71131f63cf42016380dcb547ff506c573f3e86cd1f22e02754e196b8e43f4ca5794fa37fc557df29900b9f97d351afed2a8e2b8526496dd2ae3a606c631d3962e1d6e54da947859d523e105cc0f55d57559bb2869fffab93b53991c9997075611e7722bdda73f2e1d4b659aa4f3f8006fb136972db3a0aa7c8d782f39af66a3f3a20cc33e280a7e286f1dbedba852a69012e63d9f54b942eebd9bc294e4a31db12623c1bc4ca94f5512d351f38b97f674f19aa18adedafeae7c622ae286ccab9f04d0c36308ed4fc0285ca0b00ba30af293c67f07446746d81a60c9fb4aa7579124ad3151828fff1509203d4d93c5cd3de7b45bc40572ac911493bc4a738416c82b683be2b9f84dbd0845efcaa1e0e52d5b255909d8f2c89f8a85a52548d95f1bf0847bc7400205c070a9f558c649c5b14731e233b2952b64c6a31f291c4ff698e5aaefd31a13be30103f91b6bfb714e25d897798ea8d4e9f9cd499362be6a5bcee078c076966c44696acc9c7c76f1cb582be76d3893ed42d2587db6e0ef0e2b462b50e073626a0c101acf8e69b83f85c4494a3b31e4b21bce0ec7e47ce5741bf2ad0e7beea36de25c87409c19a43cc655cdde8286802f262133021424a3995104388639a2dd70c9ae63dcdd659e36b06615cf1724dab5e052fbed7008dba9ae16c2043f25b9171921fbadb9a8ad7003c4694d016729ef1b26a644f7e298b522df5951981106c6598f0a66a0e0146a12052fd01db57507f1a6ea06d6b76f12bf6771c7c3561a13f5e912334d6fd02f6cfb81900fbfe4f3dc16271308f4ac6db8fb11993153f4d348eb739993675c27c821ef93ad0260cd5b41238bd719e11b997cc0147bf2bb6ee81b2204b4e347d473b2aaa255c6665005acc74f9d06722e09c849631e6484a2e5c84a04fa66892cfc28226751c8e2f2dc6782ae80e3cad122824aa1f26ca3e16431d04a93d61da9f49e2c0fc076ad8fd6df2e327ac4a97c8c70f4bdc3824bd3b1a1893d717b951366a8a2a8601187bacb774c3bc5d745fa817e5da4c027c85081adfbae667ff529f7a0c8c32b5dc5c6a6b8be1f755fb1296a5e34f76ff90c6c8f14b759ae2cd631ae771c5a2f62657e31d52ec49c21958b159c289380efd557457b9a4f23fb9494bdfcac2de8d6d71c9fbe3d12f3efbad0675fd1a755e26b3d787283fb942d3df4e9639824fd40d203e1cb47f09454d7739914f60d771d2a4f67311f31f6dba2c9a20b5b79a35fed248d0a093418fa9902bd79b43555ef2a60f8be473b315e55326f001cc7142e0c557ba909eea0c151cd3f2b0e7dbd5a1279bcb73c880eaf8f929dcd94820fe6cb2ac2f8c9b0bc20157c659157a23215f6e16814f8726901a5f393c8a1c308c12aa8e89d2bc3ffdf9920a81ef5dccc3786822b57b91f3b4d9e549a5c16792b4504e768384cc37f359023058494c28e036837e9e62f817b39ed83b017f96c229ad9408d33a77d7940e1e85b61f22486c6caa9e40c29fb004c0af97feece0188432d5c55d3aaf475e0fd500cbf488d9605a59225bfe42d205d7afab640bf8d335580bc6d09aa99e7c7cb4be50bc07deed355c90e29b45ccb0f864657a5e0dc857cea8896c804160fc7abbd046baedccade86184e815c1fb44ab52a1cac9e1addc4bc5b64aff1850e9a25a6977b0093a36e2acb83d2537492a75aeb880ccd55049db8c5ab67e358544d82ed4215bbb1a90fcb84298b0c6d10f921f2e730ad64573eaad1a09b89f2a4bda17612f91911816857a6cc7469fc448cffcb72618f46d9bbdc8e2828159a073961a88cdb33df6ba3f8b93a0ad4ead383fed1b1ca4dcdbfaff9d8b7ffd663795ea5da7402c585120f073fb34c06a4461d513e5f3d6d341e7d66d5ac3a2e3060701683cbd7795ac2a56a14a318b23ff2b4de6316a24f950368838a075f0919cf35f191b07073a743f19d9a302eb8c3b5db7e18f6437a7890d18ddfda7f1af5202bc4640e81e9ac9e98a0d9a8e09a9a76b0ced8dc7024c2f8d05a38e3b15589fec55f894bd11ca471ae80370457a5e88b844611399350c94031f68ae8c1ea243d3fc9b566985f9ac89e44d40bed796b02071d157fccf82cf864c7b9867147b38d5a13449b209888fe6a78bf06f8e1e9b3860561ccaebf92e7c1535faa9970a8739b3a31d9da1537c8a47fbddb08ca1c9a8ebb2911b3020c331987ebc7a37e38dd0abb2a711b14467d7c8cb428bc7f1d810fa88be812f507bff214ddb57bd9043bcf388796d421e672f01701c4455e2ec370d98d6e23800814bb480d90efe5c9bd8f4a0ee0a5546479cc72cbd51c7960a1993d50bd00ca685e93616b2468d529f26308d27fb84c122c9b5b9f00cb3f25b62420cbb17aa01e04319af0299e811f4d9610c70d06957ee8ce8b56fd5b8fd99d7eec573f460c17ef7b37d37d72681390e6958cf4c0c0be5ed3dd199cbd3631af813524f1e2e8b2f936029e2dd0d47b28e19d796f28f70b23d5a99f23957d15e2c4383843253a189b54e8c3ead0132e38683a828d18b20ad509d317012ad1cdaa550864e743c20a8d5cb9667b61f9b51298973bd6215c18cbb5afaa2a59f99769de2527b58c5d2c1471ede8d3e4c83bb54c46d113cff1264f148add314021c8a476b115fd194fdd330a7c61641c3fa04b64581bf318329bfc06bb9471c898a3b6d9b7b5c9c8139ac7d0b48731bcf00c42a3129e7e7778e6d233b4b754a1f5f2c6bfe4c697684d91c276f50b668b125a0455b675eca9708ab5dddf2c140c2d76eb3c86e115754c74e404ae74e0be4fa42750014d0609300000000175250dd216d68acf13c08e72c7d957567304281022e9f2755f2225b8588233c66818278d9077e6674a9c7106c9bb873ef62ce1e67c6679c3d26082b5d452a230987991e691e12ff6012366db1b7200f82a8e35f2538261382044915e4bd204eb60c284a82c2ada0c313cc5530707df67e9b71b4f048ed945d8402b2d7a60431687a4942b37ab9a18e0f785b294050f5b43fff5fb5d9f6ec79b4618ff8ea62fb3fa944c96d30c1418b3d535b7dbbc79250d8c273fd563b9fd8f050339da3046752ee45441a785aaa419e3a3726b9434bc3ae9bf86eb39a2093fdd3428722e496cfe0c62c8b9de85a61b53124f2b6a7ff07ebc9a82f9415ea2efa84db7891956a1ab0d01c002bc5e67a35672b868f8f407bb6f40e55b6a5b9a14564cb9a5d6fc8c3299670e5a8b3d23e27bc678c9bfd92a38124117a006ae173fb0927233de9a9b74396f4c6b31484bd8437b858ced858a8ba5b9fb97685be123f8393a4fccff7e050241ee38a6d2af7f12eea9442464d8a037d634f5adb1ef8f3e486e69961d76d6adddaf1a7299f133d048be3da9cf648d4da2284e2f4ecb9ff9b230d01d57830af4dbf941e0e95241c1ced142abe5bbb891df18f48b14c68ffbb4ba4f4c18817c73320710a0194498bb897604b8e253593a465454af8ba49bbd13eba7d2d9e0a0a8c1231b84fe683c140903f9cf4180f52279b5a5cfc18f8c2052db9c051164106d9c2ae484cf514fb30782591fac979ca0991fc3f9e00eae5d94e5dc14ebb825cd9833e1db31005cb8039842a4532f2fa6ed6012d7ce36acd673ce2bb28980b941ea3cf7262de8f49e3851831b57385a701b65a5458f42b49bda193d8bf0b7203d9a321f89e9160c4c90088823771a000c63a32ea42f7144bd43685520decbaf839e5223cbf869bcb8745ceb1ff773f9225f1b98454b60914287514ddf2dfb337720b250605db470eeb1ed68cc8add186da03985d4ac2fad0adff2c142bc1a3ba6d403bf4468a92012f859634e9be1382cea25b016fe82fbad96404d20b197f4f42dfeed427634cd10bdf27e3c1bb1eed633b04e8c2f7e6cc23b6ae636ed394941adb5ef8f65972424a03aadd2c14b2fed509613cc9ff6f91e280ab570e44368f6b7770543afb486ccae87198077955a24f6aacce4cf1acc0c735d7dd194501674011db563f2c2a1d49564d4459df33abaf29f6a1d5230af8dd0ecc8a037118146a2e5a5f8343146ef179e7895c30dba44f7d2f1735c21dc26831b7b0e0e90734a4812739910ce73bae566144d81d596b30aa777804eb0084b095e2ceb60d9636561ba01b0b4cc24fe648fc78161495d3033f598321293ff6dedd96e63e3e0768abda61d60f7aec43658789fcdf190106c782f4d06d2d67132c9df6e4157fb5433be52c101d164785b1a14647f0d21b4cf32e734f727b9b81fa72d7ccc5a435c35fd28c2cc1eb6ecbbf3e8caa615d04264f50bb942e3234c9f5994049c428c88650496b99523630c5e678001aa46417844c4f5e4f8542ca25e3aab7cc42d2eafb22d9ed455568ccc41e99e27e540d87bcf243f82032a9830116f88d1a3bd6ab09ebc19f6e8bd8dffb5346cfc75eba397d52607f12d2c353abfd82b82d36cbd67eecc5f748ca6bc53481de22a6bffce618db1313f9aec0751accaafd6dbc7286aa82fb4bc0338efe814a7dbf4af8d9e385503db6515d140399fb10b601c85f2165694dfbf60a3860c10bfcdb413a706a3faa7f6b86ecac9244a98b2f2dadc07b820862d2226474e71d6931ed9f95c7c26ce5ed5fd4e10784d0aa5c2b51e32108822e34ec016388388a9b41d060762dcf0d212b25c4d902bf620fe9dd947e789121eb94bebe64a51ebecf7a1238ab583131953701c81ca8cf95c54f20066aae089a141059c5cdc2d538dd6850dbe1965fad449792390ebca2a918059b3c71d677ec46c59100c19110d6a3d8c652f4080dd34c0b7782f2b6c57744637a9ee669919cdf53da3ec47670eb2c4028e5468de2c5d929c24c94dc6610c691d159cc4f93a2b353cf7fe0d08ea77c64e903c68da326271e1c76a5fe866909f5b285df02a3b9773b56bfa560c14f2a5e09fbe031d063c919a2e972ae5cfac6cfd79c9ca64319d4a321cf37d53893b21bf04744e5a2322506a79fea01e5ca36fd6520abbb8e723f5705e8d6e25b90e4b53202cc0f2f5c3ae69d9c5a1af40f163b78895743ee2bc0a958d760c85a0f4c03f6b398b443659fa939329173f96ecf90dd0c997b26efa1d5dcd3a8cefa98a4da53ef7380a57077a96c4438f153a88f62d0ae384e8686127f1950f0c0b79fba213fe6eecb69b93fd6a9fa0fa00da393f2aad4c2af66e8e933c8666748a90a40711cb61764812a243c1b766105b48fe347526b8664ca76365aacdaebac1680181cefc1248b605b3c017ba0c2db02ca575051d3a5bb0aa165350c7b3bd777bab84788b2ec61e1d28ca9342520273e370529f77007e5f7028c308e75fe3d60b4bc3c500217a64bf59712fac08f3c9d09f4ad7d357e074a5aa28ccbb4c12877df31ac8fd5f0aa620a77880298dc35c3682b0b3d56ec03fe62d9dcc8022a28bcfb9a3fc0d6ea13b624050415e314f389d99a4d1f7ba736cc2148b3f81aa6f79bdb899187051adb627a111a4231570f3284c7dad56eb76a8adf5a8578aebe646910b5e5140e6e8fa3e579b6b6ef1c74863f121cb01132142810d0f44d0486b04fa4471f92e6d70952f83ce512380f49a1d9faa450076b5c44ed4da587f4189370f0ee284d9f071422d3b222fd90c97cfa1292de31db608d6a7554bb8b54183c094cefe4fe737449011df15e61aee4e9ec95fb82b371b934d8e0f59daa0b236b1e59ce5424439cd72304f794f709b79fe4eb623cfd84e5081511281949e85a76c551637bdbcce9f09abf9416b0d1036f3f08d075ece014fccf842dbc2f36077293fa03027f72f14688e111ab78e067d88e3ef2cd7445afd67653d8d5f2bcf3e421e0da28a60cddf0c672514b654e3847ba1908adddfd786edf367c15ff596fc4be84273d5768b09e3bef867d979fa148fc702a3ad18f38a577d316bca705db5cd0a2627f531c9178321b59529bc7785f8a104e3167cf7d0aac7a30fb16a8b010e56087a89439e7833005f5fee46935794dac33c192c3582d7aee80e6adfbf2bc90a0e5ec90dede3e19ab1f3ec7c1e9a0ed6ca3770059ffc144dbf0efb70a05d1992b684277b0ebbf93190e30109d562416bed7c0d06198e0201ffffffff0140420f00000000001976a914dfb046745e95abf6d4cb7a1710f6d65bd2b9cbe188ac00000000');

    const inputObj = transaction.inputs[0].toObject();
    inputObj.output = output;
    transaction.inputs[0] = new Transaction.Input(inputObj);

    inputObj.signatures = MultiSigInput.normalizeSignatures(
      transaction,
      transaction.inputs[0],
      0,
      transaction.inputs[0].script.chunks.slice(1).map((s) => { return s.buf; }),
      [public1, public2, public3]
    );

    transaction.inputs[0] = new MultiSigInput(inputObj, [public1, public2, public3], 2);

    transaction.inputs[0].signatures[0].publicKey.should.deep.equal(public1);
    should.equal(transaction.inputs[0].signatures[1], undefined);
    transaction.inputs[0].signatures[2].publicKey.should.deep.equal(public3);
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[0]).should.be.true;
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[2]).should.be.true;
  });
});
