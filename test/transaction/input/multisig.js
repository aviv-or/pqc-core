const should = require('chai').should();
const expect = require('chai').expect;
const _ = require('lodash');

import pqccore from '../../../lib'

const {
  Script, Address, Transaction, PrivateKey
} = pqccore
const {BN, Signature} = pqccore.crypto
const {Input, Output} = Transaction
const MultiSigInput = Transaction.Input.MultiSig;

describe('MultiSigInput', () => {
  const privateKey1 = new PrivateKey('2ShLGGW7NPNdTJsYKkVxx8Wp5ThyASmpumDKkj5P8iCGia7s3yXY3AnhCQRs9kQeYEoHjGHgmDCLhynE2RZPfQYh8ej1YGK');
  const privateKey2 = new PrivateKey('2SV7QR25RCZAT6GeyhmTAw6Rrm4JSywAUKow9CWnY277c8BeHv7B2UNJPm3sG6zm8cSn2qNozy2yco6nVFMuy1q7ojNdsUB');
  const privateKey3 = new PrivateKey('2SWYiDzgzw1dmDh1SfZXi51kBUD6A1Qzncjf4Fgi1zm4LqxaM9qtRnLULeZjwMc97sfxwAka9j8Kz2d8VSwgFAKuj8AUgmg');
  const public1 = privateKey1.publicKey;
  const public2 = privateKey2.publicKey;
  const public3 = privateKey3.publicKey;
  const address = new Address('Lfci7ooSc31oNijNG9zDeHBBHJddxrPEKX');

  const output = {
    txId: '66e64ef8a3b384164b78453fa8c8194de9a473ba14f89485a0e433699daec140',
    outputIndex: 0,
    script: new Script('524204401a09ab4ef7473b4f7f59f2c9bc8413b514cd0d5bc1c5b3f4256282d1edfd3027421e16944bd6e863a4dfe843c0c8f0524a1e6a4afd03ef2d7b62582c9c1bd1a74204402c95ddf8dc83d7ec53c6181c2d44904fb6e77e788a5564553454e73dab81d15c056ba6ef65a3dfbaf3083c40f774d15ae2d79a6cc06099956d44a7f3c85646a54204407b51912d071d2f13494fb6413683522ea3b141a58cc316de21fa411109bd62bedfeab09fab9f14e6501239c16d7faa025502672912159cc0e7874f46a398e89753ae'),
    glv: 1000000
  };
  const sc = Script.buildMultisigOut([public1, public2, public3], 2)
  console.log(sc.toHex())
  const add = Address.createMultisig([public1, public2, public3], 2, 'testnet')
  console.log(32, add.toString())

  it('can count missing signatures', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];

    input.countSignatures().should.equal(0);

    transaction.sign(privateKey1);
    input.countSignatures().should.equal(1);
    input.countMissingSignatures().should.equal(1);
    input.isFullySigned().should.equal(false);

    transaction.sign(privateKey2);
    console.log(41, transaction.toString())
    input.countSignatures().should.equal(2);
    input.countMissingSignatures().should.equal(0);
    input.isFullySigned().should.equal(true);
  });
  it('can count missing signatures, signed with key 3 and 1', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];

    input.countSignatures().should.equal(0);

    transaction.sign(privateKey3);
    input.countSignatures().should.equal(1);
    input.countMissingSignatures().should.equal(1);
    input.isFullySigned().should.equal(false);

    transaction.sign(privateKey1);
    console.log(69, transaction.toString())
    input.countSignatures().should.equal(2);
    input.countMissingSignatures().should.equal(0);
    input.isFullySigned().should.equal(true);
  });
  it('returns a list of public keys with missing signatures', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];

    _.every(input.publicKeysWithoutSignature(), (publicKeyMissing) => {
      const serialized = publicKeyMissing.toString();
      return serialized === public1.toString() ||
              serialized === public2.toString() ||
              serialized === public3.toString();
    }).should.equal(true);
    transaction.sign(privateKey1);
    _.every(input.publicKeysWithoutSignature(), (publicKeyMissing) => {
      const serialized = publicKeyMissing.toString();
      return serialized === public2.toString() ||
              serialized === public3.toString();
    }).should.equal(true);
  });
  it('can clear all signatures', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000)
      .sign(privateKey1)
      .sign(privateKey2);

    const input = transaction.inputs[0];
    input.isFullySigned().should.equal(true);
    input.clearSignatures();
    input.isFullySigned().should.equal(false);
  });
  it('can estimate how heavy is the output going to be', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];
    input._estimateSize().should.equal(147);
  });
  it('uses SIGHASH_ALL by default', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];
    const sigs = input.getSignatures(transaction, privateKey1, 0);
    sigs[0].sigtype.should.equal(Signature.SIGHASH_ALL);
  });
  it('roundtrips to/from object', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000)
      .sign(privateKey1);
    const input = transaction.inputs[0];
    const roundtrip = new MultiSigInput(input.toObject());
    roundtrip.toObject().should.deep.equal(input.toObject());
  });
  it('roundtrips to/from object when not signed', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction()
      .from(output, [public1, public2, public3], 2)
      .to(address, 1000000);
    const input = transaction.inputs[0];
    const roundtrip = new MultiSigInput(input.toObject());
    roundtrip.toObject().should.deep.equal(input.toObject());
  });
  it('can parse list of signature buffers, from TX signed with key 1 and 2', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction('010000000140c1ae9d6933e4a08594f814ba73a4e94d19c8a83f45784b1684b3a3f84ee66600000000fd1312004d060930000000001d0aeb172c9ebad6566274c79c533295b85653cb961cc68bcf551b9e0802db259ffedeb2ab0d3936456453c5f38ebf1062e39d8f373bf29770cb4a603092f2381ae3ed0cc893a6566ae171a5a93f712bc3917534d3114c8765b9c7980dc77066a62dd3a2a2cfb2af15073acaae0a17aa2e8a6c562ed4d8f1a4ec11332291c075fb820f8ccf20e723cc37270940eb518a7345ada209af6c664a84e897fe465b2995af7206db0c77e9973246f37784df7180dab608e745fb159652aa27eec4ece52ada1e18a814ea179c2845eaf2c564a99954a3305b71d05fad1fb3f81c44371d10f7eef25d7b176fe8183d710947352007b10f78d4b5acdf0ae245ec34cd90cc6b5dc1202a7acb3dd191d56c26048a1ee91396e93a7a540ae67274385236396b028761208fbf0013487e601ba226f13486025725d88dcb9994c406b1ea33331d2a2c09b3ad31510a732487fdb97ba16ef98d4231794b58107b59a268e034e8a14edd8eae3f7063e98eb22370ab59a32e6ebf1a1708a0dcd698b78eefe9c4a7b93fc9c77ac5608cfaf91a945bd04cea4a24e1110d79017006bd167f8f6e5713764d5b6bca1ec344bcb6f488511aa1edff7639747866b37f3c405f6b6232859ab9374dc72f29dd4d7a1f8567e386bc1f59fbf5c6568780ceed856219e2933f9f72bb65aba526450cbc615e53f1816b5632866905378aa31283fd2f2c75fc1fa43faa689aa78a0d7413b691bedf0591a5774b601e7fbd7a04d959ef4ba07c280c50fa43b17bfa79f817cb3511340abc30c65a44aee47b842e1e356d4437cce8599487444b742f91f81f94c29541a2fb58f1fb485637c6b4d7dd8eb45c8c6815336f0c2782e533cbdfd73a534359074c510a2e7f59127069bd439ed507dba1a517b0aabf09c6ff90150d67a83e4075f9d71acd76c63d862c41f34ef3646cc2820d2b06bae09ce47c0fc5bc718e7b90020b4be9e7d44d2535845619463452e447069e07b074b2b3ba2861cb7e73915db431f63e8f7950712623e85a0e02a344e048ca5adc4d193b8e5072aeffa6ca63b60dc0fc8c3046bb0ff61ddb17a98ff5a604332e0720ce2d4e5f49abe7e377be4f16432879a8476567220c65fb66c6e59fa4731ed37a8a1f8b095356e41259a8319c37201e8de386ddfb9cb475fc9cb0371dc73b21a501174614f063344578cf7a4bd4238283d394f9d4325d1373b04d1e97b39a6c0f8cc02789a68684c168640684896917f934c06248dabdb51acedf26e817c1d8882a65809a85f627f8a488affeba64876e2d3e2e2f4300609da487ed1e5cd887a84e07d54ec4aa1240e9ec8b4f89f7b2c7ce2e61ed8649931601fac4edad3bfd57d0f43272899a03d66c8674a88cf6324b671f2e71f64e719df76045335ac9e9e3f6e7fa24f577fedc8abd999589ab3d528ed22d1f9eb0ef8b0b06521210721bfb3bd6044ca52bb3c29706237b72a30c258a615a5cb08d8bf8b790d270f9058d6c9bb99cc232fac515b0e0f61f8be0b4dc71e63b443b5f18c3fad4d88796e313713205da52ce07f2aab47612bc9787ab16f974e2edb4bdbea7c24ec44f58b5f577437c6bd2a5e64048ae957294669d0d7940b6d45409d91f24c8d8f108e1d84c035ee5cb557010443713d447892394e8c236537dcce02255f204498bc5e0734278a37aabcdfea189391036e47881f2669f9eb8e9e1d768a2d884cc487ac018f4b0dbf43aec2d03c47e8f9665bd205a1d8f1b7a979fc20ab2d888cea89e3220352488e12ae09614014b14d42cb7c34439dcb5d114c7f5d682b9be24ef9ef4687654e3f7812bc369fc1e0bf8810c628b315e31e09e7f2dd51f9bbc7a0894a23d7364c3054056720dbf6b6b35b8f0222f45fa18ca7f407f8a145340498eb56d89665e218f3ff0caad5d4558ca4b13ce10f42c2445e767b5345438c5e40e90f104d5310f3648278525b13b59db5ae2800f98d3e736505b08232034c5fbd712dedf6aa4f2dc0556ed3c2a45e0006b73e99cc1c311a71f1c51384a5e82970c54c5087bf581c21f03b9d796c05b0f4282fb5836b45a2f6b2a095bf69af4e8dad8f1a99b68978bc7463cb419cb06d6b19c388f8c07eb836e78769718342ef3ab0c78101fd9886c79d67e357013830c16a1b49dfacd8a91f3c35df84d377a0c5bd0220eefb88b2e99617ac9fa7bfe41cfd61acdf207dc756a6dcbcde04bf3ef335f6153fec73029a69feee8bd57e0473509842d223f921a1d607d7a9dde8a8e5224ef997643f531286fb2f1790a3a4636f646efcbf428cb4171143dd61adde91ac7fd23dc9f8560621ecf4adb6e7cb5f7f7c9767b30183412fb50cc09ce1d71d6a26e3c66bcfa2fec44e3f4cdd8ed8ba0a26bf127452c9727f931199dd307ab97a5e0ebecc40855dd059484ce9ad05927c2dab53d81f2105744362e84a26bdff1be12928d932e05076199773f3938c6cff7a05f59bd1cb70b326a48bc5200c12104b3ff56ffbd127eeaa484e11182c0bb1894a7eca1df43913aca6fd8836720317a5d5c397200218e76246ce5e850200a5f9fe148028e27ac1db97823607cae6a5abcdf77b41ac94c9882c678354f487bf4d966c23fbbe607398b821b9033f3e19becd5585a732aebb4bc4d62f69ae9b8bdda753f7ea55cfce55524b414bbdad62623a094afe02bbdada42b431cbfaa9bac718733678d9c1c29b6f8f965a56a34b411e5c4abb698f6872ea0af654c18fa0e7c157c34e4cc58ff1a0b3d953fd8f32a79e780f4a1dc9961b0c902ecd9a30677a13131ca405fbd1e5f204cc4fe9fd9485030bcdc4f933d893b9618000cdddd92202e9dceba3d6007c9552a213be54913472adc9b3357f2a62629b03f6da71ddc107b67e0543d56244bec4d682ee8f5abb149f7150a75bc5b7df1b09b2c8874b7e29cc2c473d884a47a7845691e4b8b3b9ffeb6ec3b40b188fcf2ac4f49c1e1b007a7f84c70e9e74ac8e6aecf23854420463f23b09ae3f0db589d9318b8fa3f5a36fb08ff09ccd942ee3d824509db128655b3d048836241deb2dfcae22530a94fc4d1cfd287e8b7ee2a7c2aaf9233ee870c17bd09ef4463506d0f72c5b393d930c39310954c2699356fc3c9a35c7bb8d575c7a30fb16a8b010e56087a89439e7833005f5fee46935794dac33c192c3582d7aee80e6adfbf2bc90a0e5ec90dede3e19ab1f3ec7c1e9a0ed6ca3770059ffc144dbf0efb70a05d1992b684277b0ebbf93190e30109d562416bed7c0d06198e02014d06093000000000c57c9bc92496dd63efc7e449288dabd59a00e5e1cec499dae21624912ae0e905fcd9f6d37e137b521aa2b196b1c69380a40308054fdf686b9614cd0562facbe9dbbf0ed4d61f4f4ef8549131c44e7f34577107e75036075fcee62023defbb57fa4388f37611720760ffc98e469cfa1e4a7603c7ab35ee88e1f24b3156fd645a30704ac79dd79ac0abb8ed67bd0665041dd0a797f07004039d79757758ad89d00ad1b634818975849c93768ae916333c64347c8dad75cef7b959bec419110460e4c02aa6f830cde9ee400702f9551f9c79d3ecb040cb3ec735c1fd0915513bec2e5a1684b78320fe9b79af8899d88df213f4447ac5027e455bd504b9d804cd6e3d6a1a2636ef6bbbbbb2a8da53ee2bfe1bb5a764b13daee1efc68e445716ad6e2019c10e70acffbe2470ec3284f441142467e0c76f01abedac516d7ef65c42e0a3b57d00c851b55ccdf2792f2f849f152d0a0af4641e27bf8748b5b461bbd8860c8cd442d8cd511b71004b3d99aa858aa9f6cf3a9bae1d55d55c69504f7372f5d4c91c110282cb80b25100cf24c5424dea4555ad70ee0d4e737345ad816522c3ac104842cca7dfeca786f10af532b1de0afe068139485a2b9a66330bc0b0f6f8c2bc3fb933e5b36da8f1029408f0275d0e2cf2b64e7ba608a90b918b4ebf2a13dc5768431dfd7885c92fbc2b8002daddd4df21ac6d4922ca1ccf56e779d8b5aed76993fb71628832639d12d5c758b116a6acdee1378fefb5058c39abdaf97477dd83ceb629b359b6fe215c6b1537b212306d69e5352ffa02700e0cca3a7a4fb270ebc0247b7ecb9a81cd38e8dee3c17761e36ea5b340a6233f62fb16557e5c53b78569546ca26b63bc9a30df093d729a39b3d89d75fb53917b3a8f52693a00ecd2099c57801dd96fb6e21b4139ca7881be1eb74411a3390669e18a6f6103bf42366cfd1e6bd8b6f4bddbb624eefcfa8970f832f7bd966212b71e24190bbfda84e263d48baf465483cbdccf5be0669063dcf0f0970ec3092384dc0c6805886ccdd8918d2d39e5029701a6efb8f7aa3d13144cccd467b8142b53a4e3d51d0ec188fc13971d543338f10bfef82171bf69507b4d20fdf36d37981c704713b14e3271e45391fcb3b0ed03c9417ea4a1773b285b21b45bb1a7525f0aeac5001742f4e55986e8b3ee322ff5eb312c9eb8a601c197f6857b7fd71f8e67215113ffccf2da65269dc57a90dddda9f66846cfea6988b458bff500ef59de36f11a64f591f45e702d75f6e05af4b110e562f0e0ece1f83269db7bba8e4f21462c459544862c59531b23d3ac8056e23e90df3fcb3511c4371df01f96596de1f874ab08418f53c22329e201e6c459e1f613c457ae8f8469014785a2ec1dd18fdc917f8fc3c16b374726a97b6ffca3c7b466538d60f18e26b87c8bd804abd769137fb676521cde9611d0e4b4714eedc7377ff85cd79ad201869994049677e802677fa49908cbc23ff4726f1a7c1c962cdd0312e9efa2e4254d8a7672eb71866d4e2afd9043cec9c8979e75c4a69efc611c6d2bee41f2c682274116c98033d5f6620d895674d5a10065f403f18f3918cdef332541b40f5617ea12a999440c2e363a8f4b16522193fac643551be31bacc09de21f116adf08b220d772534feff16b9507e7d59609fe04237cb68f6c8d5927541ed266ddc8e6f413a40a224de24e54a3c453fa3bdc9b1afa8ec6c4db4d26e2f3f61f75de8cb786aa330abfbc015ad2314b820b307809d9b9ae05bbcc38bd32a7c1ce98ebd57f9fefa703ecab9b34eac4207caa4a28be05df26b033fa1a32ed507abc8ed21e47ebc0043b661f03135c806b394dcb4fa67ef04a8908eaade7fd401dfbd29ec465ead577fdb9fbe93341bd194f89fd9b5067693964077240a2285d42574ae527ae0858bfafbe9a6f755212cc43df45392608c08f97c3723c96806f3af1cfafa147969d884ab1c6198f29102c8f0c56e900445ebb09dd9a5f74127847ce4368185d2f6c61cfe8546560079fdd9d1a2791b732d527a6633552d7beb3202d8331a0a8ca1aba0df7cba40169ba47938b3dd6dac96618500d20058cc7b3ce753e973c7cb6560b04de98260a82a44a9b8ea851b26452eeb2a14fd8ead08e5c67df961e60604bb9e07ce405471a7b2330f6728da046ddb22786ee0d8006954f10003024fc5e9b81646288f56a260706f813a57f14f4a3c38b09f1bcd21e9240d71d2c5aa0faff5eece88d4ba19bbbe451fa6581f25e1725f118d0b74fcb59a393d23c363404222942398d88e1ca836f6d6685a4e9ce32dd5091a628a7df8808aead710df5d1697196684bf0895503629943630c7111f5b45b4ad3673046d4028e2cfdb09d74c4220a156c0242ac11b0b8ed87b900273527679f44b99853908327339238703e9ba70e9cad23bb6885ed0b3c2a54fa4f2e5efa9ea6006f1776061a5fbc6861e1cf601ed6562a60f3e5a198e4a496351a58ec09c9bb2aaa5ca99bf82e1b52228fd086ee47d35adc6d7c0980e251faf5f0b45e8605a3b341a4e7bdcaf491a27637b7fc2099e404474e3b0e6f38bf3453b1db3a788471fe7ebd76e49f11d39bc3060b7d1e1ad6ef9ab08d23868917a594819a59be3b3a2d8407e8d37500cb4ac5d33ebb7929314df831c9236f62221e1f461e0ef939cb781aeacb7bf9d365c52bde85081b0e83dcdf753156e17e61b4990f0e095257ec3d92e147d32cf824a06f24d70b2c75d7657472b4b21af5943740a9222310b89e72f24365dba64897293545e361b26621eab79f32f93948333777c317f32defa8ffa4655e5684b8fecf14e5a8b7145dbf4bb0bdbaa26c365f5eed58a5c9014f712d5bcab0c1aa9c1349863dc749f9fc4c3e8e8fc20e705c5ef33d2688ce7556b00cd2b74ddefbfbf976731c811c7574d5a0f49f3aa9c9dbb92c83f163f3b91fe80d1ddda86d04b51d9e4acf4400e5cf16e060a4351b95dcd53e3a06074f3b46214028801da4301f829ca9c74c40d0f52431dd1f37ea11884ddf179787f301a6240a2914ca9a909d196641cb99cfff393503961b55e31f15d7002acf9b276cb8544c9852d026cc946224f4d17dfbff63e624feaf92555f4a6f032e7d44da91f3eb9fdd10cda0db708e56dd1197647a558599ca9f257fcfc00cfaf45ebd22ec1ae74d96f344314e3ccf69d803e33a43097ab4804497b6f6b85110d068670009a8fb8878135a7497a039560a83ecb90c4c7ca21006a452774365b94f55801ffffffff0140420f00000000001976a914dfb046745e95abf6d4cb7a1710f6d65bd2b9cbe188ac00000000');

    const inputObj = transaction.inputs[0].toObject();
    inputObj.output = output;
    transaction.inputs[0] = new Transaction.Input(inputObj);

    inputObj.signatures = MultiSigInput.normalizeSignatures(
      transaction,
      transaction.inputs[0],
      0,
      transaction.inputs[0].script.chunks.slice(1).map((s) => { return s.buf; }),
      [public1, public2, public3]
    );

    transaction.inputs[0] = new MultiSigInput(inputObj, [public1, public2, public3], 2);

    transaction.inputs[0].signatures[0].publicKey.should.deep.equal(public1);
    transaction.inputs[0].signatures[1].publicKey.should.deep.equal(public2);
    should.equal(transaction.inputs[0].signatures[2], undefined);
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[0]).should.be.true;
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[1]).should.be.true;
  });
  it('can parse list of signature buffers, from TX signed with key 3 and 1', function() {
    this.timeout(20 * 1000)
    const transaction = new Transaction('010000000140c1ae9d6933e4a08594f814ba73a4e94d19c8a83f45784b1684b3a3f84ee66600000000fd1312004d06093000000000f30a5e943fc88ee9fca2cf52319d4072a8ebac77c4e154e8a3a6f53742f13bef952f099818c567fe3b3e7f09c5324166ffa372a1fd2671c8db751c3c2e957a10f9aba24886481ad908df52ae5c8fa25962c7c0ef01d523d79c50e8b8b12e9ea0c8e20c79050696e2e382c932e4073c3b31bc82426b90c82616d3137c55802d2bf6df6e11a601a8687dff5fba0806a01ff029c553f4399e563edbdcbf4f04cc615815b5f1c96d83aa8177925017a71f730259344085d78bb1ac3c4d00304e75b5c7cd3b79bdb2a518984f1af1dec849259c808b62160b16223562562c5b841772653255fa3e1e39f86b08db889a1523033927e5d1ddfa67c83e49655968d003d27032a19ff37a73f8365b0c6ae555572e599b65164a70eda4365368f5fb86c55e0238d8990f1cb03f4b4b3f13d5dc8dd9a7d4d03c2847c4e40a923fe888622dd61b2d66a8744646d3a8260849c7e21f3fb2025403873654d48ea01400eaff11926b54e1c5cf9baebfd25dce807a8f71a761df3c231f7a733411ca18af00b314fa406c5c91ec1bdbeb8f7b094849f67d95d65f2b23d6aae149437c0f873a2cff50c27b6f50aece22bdc330328aeaff2fc41f2fe073afe9739e3c01f6fb977503ee3e6978f1af727543d6ff3c3cf1ce9c04de711dc00a70c212c6b9d3d2855926794fcca34fba1b47f6591088b24697140371b4c21758886a0065b816bcbb4ca1db10e357bb1c667a08f9f953e80c15c52aff24086703780a19658c5ddf2ff8bffd6010d4426698d0eef58eddee9407b8922eb5b7db249a1888c0566b527952ffd1082fa9f27c38add79524534953e0761910ef2532323a6af5ed6a44d53710c6e86470346d9d3e8d5173a1c77c8602603f613e70c818227af17d9e7fc75c4bf43cf8c54b98a78a9ea0535aa03cb3df7442d0e9c3bb370a03e93d409a2b90b135383133cb72d9951d743c402613c5e03445b637199969c7d075352840aa09d3dae976e71300512ceacb7a188a3a0b4ef34749f8a15a3b9087694b28f0f91424114e3b8c8d77317e57456ebc386e4a2c75abe10c1882e2894945058999a2202d51f6181d7c0551a51561cbe2f5feb9e0b5dbe968464d40b1bafecbc94d652d2806f2f7059aa14a5a6e5dcafd1f7c5290099d89034fa15d515b7acac6e84827e5a144d42acef292af4e2ba9f8b17888f10af0ad94b7d1f2a2560fdd82a9b071b9aa2bf1697509c08336e412d6834a1517fbea53b910a3a8eb966d54ca3680d671b3c65f69722595a601d61137a408b4795226f3e5e099434060057c8cae67a62d842fde3020714ae6b968fb890b7b8e734891d2328c30e7a0c548ff81ef18e087fe1c722e09c849631e6484a2e5c84a04fa66892cfc28226751c8e2f2dc6782ae80e36e460bbeff1df82f708e3894392bcaeabc84cddf6f0606e23bc7917ea3fb6840e74e3ca54011c1a61785a3de0c197d24b7ea05470dbf8b145f7b0a6cbf15f893c3aaa4d2d058555fa3957645a8bdb9b259a75077b63b9786b5b73802477bb57c0658bb704cdcdf2e14340759ea4176423ce1323900c0b605e4ffc810de10ecddb2cdfe5a24917557b9245f85029382a0b3f6fe8ba5d87f122a3e4a8badb887dde2a02eeb27549c12f93f7cac01207aa13d94fd30d66cec7be6a67c040d615830daaee25dacec152565d214abebf8cafd1661bbfbfe1a4e3788fc6c8e5f7f99509902bd79b43555ef2a60f8be473b315e55326f001cc7142e0c557ba909eea0c119875b7a7634d51132c7a6ce8cebe5f8b3a77a8f008187434de31b31ddf350c2dd39fdff8628a691e61e3498de294677a6fc6413cf4e418edbb7949efe10f29a8f4e690560feaf035e40135d0e9dceb6d4fc1800ac159701cfe3e753edddc61c9023058494c28e036837e9e62f817b39ed83b017f96c229ad9408d33a77d7940e1e85b61f22486c6caa9e40c29fb004c0af97feece0188432d5c55d3aaf475e0fd500cbf488d9605a59225bfe42d205d7afab640bf8d335580bc6d09aa99e7c74ebb0b58ca228df10e292c5cdd41096b20067ae56a627e0c3d55c5e94f05d27b77a7126f78acb6ca3ca1b98ce3034a95c0f95d151857d13b673376d32385c04cffca193ba23e67c1161f027f4297b5c66215fdd7d5b9adda2e3a34b92a2c213882ed4215bbb1a90fcb84298b0c6d10f921f2e730ad64573eaad1a09b89f2a4bd8155a27e420eec400ea651590d923f46e6409792476199c8cc22b7bee3529800ec4574452c10852b39d84ab9608f3818b886ae45c0716d33253dd614b3653961181c58c2ccbe29c281cd8baebd36bdffb150904bc9636050d0628a913810637b5f58193120c3f270c65fbbf17aba445baeb44b5c2bf17266d11753792c4f09dfebcbaf28b41da39abbe0e6684678c9dcdc39098d01f086c7eff5e96336ad8e2a1df8c69eab4297993b05e6880d73d17a99f18001c5fe2f99587ab8baad12183c519980d138399243a5dc5a27559fde69bffe157d24e158421dc0b56dd31bd7c7ef24cf681f04b1828e82df2d2050a711f41b342f57b1f7eee2ee19cc3be82507d34d9c2e11fccc84aef3f59069957e0ffcd22f3a582fdc40cd0c3faeed64e6ac03b669c08e95968052f76daa3dc4e9b1f194fbe2a7923f6ea6158c864a76b98c768290ac79ca97857edb85d291e0af5afa22e263b935ee0245c27438ad5e49265057cdc83e52bb3def55416aaca96fcc68d5a5ebaa6f653057f7a95ad507748f41bd51d03c5981c841db7a12d6b2a2d5f5ae9144427d1757b097733b8428ac6c300e4a367c6c0a464fb7b87ccb1831ee29697d90c947476116a7bf9c6a87237eb7a4d9dddf4ba530d502847b0e1d99f5e3960fd0452a8702094c18ce10675d2d958cf4c0c0be5ed3dd199cbd3631af813524f1e2e8b2f936029e2dd0d47b28e19d796f28f70b23d5a99f23957d15e2c4383843253a189b54e8c3ead0132e3868afccad7d96bbb6ef418e6bdca4d398963bf2aafb5ad74a286134f98228d1e6eba121436a8bca705116644357b309207766f0ce03af683458bcb3f1f48ec75e7046d113cff1264f148add314021c8a476b115fd194fdd330a7c61641c3fa04b64581bf318329bfc06bb9471c898a3b6d9b7b5c9c8139ac7d0b48731bcf00c42a3129e7e7778e6d233b4b754a1f5f2c6bfe4c697684d91c276f50b668b125a0455b675eca9708ab5dddf2c140c2d76eb3c86e115754c74e404ae74e0be4fa42750014d0609300000000175250dd216d68acf13c08e72c7d957567304281022e9f2755f2225b8588233c61763fc97366a657ecad1c879ddcb7ca25bbd5c8a39d65d1e78893147c17a0f2505a87aecb3491f5e9a8d45b4738900100d001924e51f76f2d8bb9b2bff62d5a2c1b0319d973461235052e87fec1e41f14db16a36ec57afd1bef5b59c27f8564fa68043b1e2f5a8e794ba67c4a9bd0dd5db8a64d3e6405133c8c3c4effacc8d9f338540020952a689ba53a45cc209d01cc4d4b71081f69c8672e00d1fe58ceee5034ae678d0c0472f25d065933240a90a85ca9b072fdba210591ccdec5782585f943f25a7c362dccc678a1f12716e6eec1c36adb7bdcd4189ddb308537e8e00c5a5e47d714d81460659e3d6f294625deb0961b89049d2a855498bc7624ed37e73989f0be0042b2d9a6143150ee4066b5e866c7a1db4fc5935a08825c4796d2445c9e4b3b0a2984ea7f849d3744b56dba5aea356ef7aa426bb46c245d95f5bdc6e5be3198bc7c5e67435ddaa272dd2143e4e14064e9d702d5ccf51a1a2d4c552aed6adddaf1a7299f133d048be3da9cf648d4da2284e2f4ecb9ff9b230d01d57830af4dbf941e0e95241c1ced142abe5bbb891df18f48b14c68ffbb4ba4f4c1881efde1cc461952a929ca67a920393b29d923d67425c072c2ec13ebe83b61c25c31c1295b075df7fec966278d5fa6c61804b4032efa56947f1bb983486cc7a07810e37c7d297f745dffb4a18d4bcaa37a43b2c58f4c1fc0de65cd44317fdc0e34925cd9833e1db31005cb8039842a4532f2fa6ed6012d7ce36acd673ce2bb289801d1484949853a574deb0d5f7c25401bd345ef5d88737390fab6b9cc73817058101338c31f7ec4e4cd23dff7264eb2ead27e70cd55484abad2440b904d1b45f09a5a3e790e3824cdbb756301d6c54def5554c1d0249709db25fdb351fbb30f851363c965a45f6b732a14bf3073129344943932693ea5e2375237ab31a77ca5645f3281ef61da74366c601f2a9dc9fdee0d3d514067f802949297eff6ff24bd1603809adc85f71a6f6c9ac3773ffae29b6d3d749c3c15252b9e3b7aaaaa9297e20e49f3a5e51a1baf84b208265064c696e0c5cdb1a046a2605a5c7c30bbbaa2d90c021f356299f138cbf38c7a148592eaac0bbdd8d1f7ddeadeccce867b3fd067b85d7066fa01cea120c21cb26172fdc55e7f01f2b11a8e103714c98d0513a339783de9075c04448c80e9709cf9b5433d097e6d6810b759ba9c49b1f6b1d818353d9bb2c4f5c4b93457658edbdb8bc809f0fa7ae003b1e0c13258695f289dc24bdb25b51b12752154564cd8ccde6c909a5dbddfb18e7921c548a339bc7e052b036f02cee26016e9485f3e2da3568593bb79788610c2e4c6e3058ead7e424f5ba102466ce2dd537c8d61000784ce73da27a5f999e175c72e8cae4c2d24b8dc07534793711c8a1b2e5d7da3d0acacbec94efee3ba4db9772d2b93ef8a2a5d52728483e3e57f3c9069969834b607a451241efc16ad9c2eb12c33fc7d13193cf5421d550cf228ba9da9576ab17728bd4866f7ffc8908d94feee838d289bd00191b8c7f63f97273cf6b1b0cae7f888063fe5f68c6e68d65d91a5ae134c8877342dd7f18dbd608f1117fe3dd72791867032b30266ea8557887daee70d8a36c03288665d928714c3e6dff96b50c1b21d4ea95a5756c6de4766d91625bbdfaf297cf1a88b20dc0e141d9c55d6b76a0f04a8038d47555de5d610d7bd0e42e34745564581f3cf099535f2772261825e8dfdca10c1b5292fafaf5a4ea298ec18cf3a439dae632d567e7b28b2d3b505731a36591fd853ae3375298b3f2479213347dfa90f65fba5db1c1f2421bdec8797269b6e712adf89eb587506212871c8e76442839d4101629259c616f7f4393f6281381f38f1c09c2a2ed3edac82436318a75c37cd82c1d7ec46c59100c19110d6a3d8c652f4080dd34c0b7782f2b6c57744637a9ee6699d5cb881a12b6a9da3f29aae953a8e7f02813a71ee65b03c0ff4300749e7de28b0f31b80a58c6ebad84b315a055d462416af2d192c14ef81d401b8a891a895fc7cf5f7e149cdb1d872a385e654e55e6c348a6fbd999ec7d37d6f45aeac37caa36319d4a321cf37d53893b21bf04744e5a2322506a79fea01e5ca36fd6520abbb83d11db125642e4e5cc9d0fd500e20e123a764c391b0e9c1479d3fc53cc4ced4194f82d57f459d0dd1c02a4a7fecf026d47ca1d475d468028ad916caae5bf5f604bb0b2b79a72cc298f9a80da0aee13b63a4d878e4240708809f255db92b56214e6421d7d4aed5f096e8c499e73af11fef2e52cf5554d53853dcea2d3881cbf561346d34cdb76ecc08f79bfdb732a78e926912888f909bd57567dcb3e38d4377f33f5dcebde932f6a94a6d647404a8d5d8a7ef951b7a87a0f2a4cfcfd7bfd2de66f785c4de676c9372fb3da3c0aa9e825e0808b25a5fd7ce2478e0ef4e1da36a123e470f1d29322a2d80b83c5e06f1fc83ded383ef4f0efe08a3d83d8be985d05b5b6cae57e976ae5163319123f16c1b25c052e004fcfe79ee521478f0366d31ed25637f90cd9037d08ad54be72270c073cccbd2ee0b3cf129dec1b3c538ac9d59709725f5fb04f126fd81f78d85ceb97a3f2bf5fc4d0b07d81538ca15c2a6dfca05c17ea65f818dc4b005d7136866a11caaf95fc849c8b09db402922031b438bf1124032edd9fcdf0d693b89ce994bf3b0b7faf373cb1498b9b9feff4f0622ccd064731e0febf0ed7c1dcb97fd22a3bd1aee570418c06db66f587ce6551705b472f995b8efea4ba6421bb7932a174d63c322c800be324a199402f13506fcc27d73d608f7f11f62858d5446e58907a1deeb01ae286053e3de67714d398c73ce10511281949e85a76c551637bdbcce9f09abf9416b0d1036f3f08d075ece014fccf842dbc2f36077293fa03027f72f14688e111ab78e067d88e3ef2cd7445afd67388c30591f313172ec50ce64f9691f18c36b18793dfe67de5f705847ed58ff515e9ab2f5b277f51b0d61a80a5143ad2f7a96e5359d7e17cdcecb2eb80543a1087d316bca705db5cd0a2627f531c9178321b59529bc7785f8a104e3167cf7d0aac7a30fb16a8b010e56087a89439e7833005f5fee46935794dac33c192c3582d7aee80e6adfbf2bc90a0e5ec90dede3e19ab1f3ec7c1e9a0ed6ca3770059ffc144dbf0efb70a05d1992b684277b0ebbf93190e30109d562416bed7c0d06198e0201ffffffff0140420f00000000001976a914dfb046745e95abf6d4cb7a1710f6d65bd2b9cbe188ac00000000');

    const inputObj = transaction.inputs[0].toObject();
    inputObj.output = output;
    transaction.inputs[0] = new Transaction.Input(inputObj);

    inputObj.signatures = MultiSigInput.normalizeSignatures(
      transaction,
      transaction.inputs[0],
      0,
      transaction.inputs[0].script.chunks.slice(1).map((s) => { return s.buf; }),
      [public1, public2, public3]
    );

    transaction.inputs[0] = new MultiSigInput(inputObj, [public1, public2, public3], 2);

    transaction.inputs[0].signatures[0].publicKey.should.deep.equal(public1);
    should.equal(transaction.inputs[0].signatures[1], undefined);
    transaction.inputs[0].signatures[2].publicKey.should.deep.equal(public3);
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[0]).should.be.true;
    transaction.inputs[0].isValidSignature(transaction, transaction.inputs[0].signatures[2]).should.be.true;
  });
});
